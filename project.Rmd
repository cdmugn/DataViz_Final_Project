---
title: "Beers and Breweries"
author: "Clara Mugnai"
date: "3/23/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Making a shiny app - working with data from a git hub repositorydata set, converted to a csv for me to use

```{r}
library(tidyverse)
library (readr)
library(maps)
library(leaflet)
library(ggplot2)

cities_df <- read_csv("data/uscities.csv")
beer_df <- read_csv("data/beer.csv")
state_df <- ggplot2::map_data("state")

beer_city <- left_join(beer_df, cities_df, by = c("City" = "city")) %>% filter(State == state_id) %>% select(1:11, 17:19)

content <- beer_city %>%
  mutate(popup = paste0( beer_city$Name.x,"/",
                        beer_city$Style))


beer_map2 <- leaflet(beer_city) %>%
  setView(lng = -98.583, lat = 39.833, zoom = 4) %>% 
  addTiles() %>% 
  addProviderTiles(providers$Wikimedia) %>% 
  addMarkers(lng = beer_city$lng, lat = beer_city$lat, clusterOptions = markerClusterOptions(), popup = content$popup)

beer_map2

```

Above, I organize the data to have lat and long and use leaflet to make a popup map so you can see the predominant type in each City.

- In the app I want a table to pop up where you can pick a city and see type listed as well, to make it clearer. 

- Made base shiny app with the front tab as a leaflet with all of the beers and then a table underneath that the person can change for each city. Need to add tabs with styles and plots of the styles.

- Have tabs for both style and brewery - investigate a way to connect the app so you can click on a style or a brewery and be redirected to that tab?


Making static plots by style: 
want data set that has mean ABV for each type so that lollipop plot can be made where you pick a style or multiple styles and it shows mean ABV as well as the ABV for each one.
```{r}
style_df <- beer_city %>% group_by(Style) %>%
  summarise(meanABV = mean(ABV, na.rm = TRUE)) %>% 
  ungroup() %>%
  mutate(Style = fct_reorder(Style, meanABV))

ggplot(data = beer_city, aes(x = Style, y = ABV)) +
  geom_point(data = style_df, aes(y = meanABV), color = "Blue", size =2) + 
  geom_point(color = "Red", size = .5) + 
  geom_segment((aes(x=Style, xend=Style, y=0, yend=ABV))) + coord_flip() + labs(x = "Beer Style", y = "ABV content")
```

Want to put this plot into a new tab on the shiny app. Have to figure out how to make a new tab and then put this onto it. -Got the input, need to put in reactive data set.

- look into zooming based on the city you choose - problem! I have ideas to fix this but it is taking forever, something to do with leafletProxy and observe


-Now I will put in reactive lollipop plot because I know how to do that.

- also going to add a lollipop plot that compares IBU values across styles

- this runs so I will change the input of the x so the user can choose either IBU or ABV and they are on the same plot, with the axis label changing conditionally. Next time I work on this. 


- now have title above the table

- Got it to zoom based on input!!
```{r}
library(shiny)
ui <- fluidPage(
  titlePanel("Breweries and Beers in U.S.A."),
  tabsetPanel(tabPanel("Beer Map", 
    sidebarLayout(sidebarPanel(
    selectizeInput("citychoice",
                   label = "Choose a City", choices = levels(factor(beer_city$City)),
                   selected = "Austin"), width = 2),
    mainPanel(leafletOutput("leafplot"),
              span(textOutput("tabletitle"), style = "font-size:150%"),
              tableOutput("citybeer")),
   )
  ),
 tabPanel("Styles",
          sidebarLayout(sidebarPanel(
            selectizeInput("stylechoice",
                           label = "Choose a Style", choice = levels(factor(beer_city$Style)),
                           selected = "Belgian IPA", multiple = TRUE), width = 2),
            mainPanel(plotOutput("lollipop1"),
                      plotOutput("lollipop2")),
      ))
  ))
server <- function(input, output, session) {
  
   onecity_df <- reactive({beer_city %>% filter(City == input$citychoice) %>% rename("Beer name" = "Name.x", "Brewery" = "Name.y")
   })
   style <- reactive({beer_city %>% filter(Style %in% input$stylechoice)
     })
   style2 <- reactive({beer_city %>% filter(Style %in% input$stylechoice)%>% group_by(Style) %>%
  summarise(meanABV = mean(ABV, na.rm = TRUE)) %>% 
  ungroup() %>%
  mutate(Style = fct_reorder(Style, meanABV))
     })
   style3 <- reactive({beer_city %>% filter(Style %in% input$stylechoice)%>% group_by(Style) %>%
  summarise(meanIBU = mean(IBU, na.rm = TRUE)) %>% 
  ungroup() %>%
  mutate(Style = fct_reorder(Style, meanIBU))
     })
   
  output$leafplot <- renderLeaflet({
    leaflet(beer_city) %>%
  flyTo(lng = -98.583, lat = 39.833, zoom = 6) %>% 
  addTiles() %>% 
  addProviderTiles(providers$Wikimedia) %>% 
  addMarkers(lng = beer_city$lng, lat = beer_city$lat, clusterOptions = markerClusterOptions(), label = content$popup)
  })
  
   observe({
    city <- onecity_df()
    leafletProxy("leafplot") %>% fitBounds(min(city$lng), min(city$lat),
                                        max(city$lng+1/4), max(city$lat+1/4))
  })
  
  output$tabletitle <- renderText({
    (input$citychoice)
  })
  
  output$citybeer <- renderTable({ 
    onecity_df() %>% select(3,7,9)
    })
  
  output$lollipop1 <- renderPlot({
    ggplot(data = style(), aes(x = Style, y = ABV)) +
  geom_point(data = style2(), aes(y = meanABV), color = "Blue", size = 3) + 
  geom_point(color = "Red", size = 2) + 
  geom_segment((aes(x=Style, xend=Style, y=0, yend=ABV))) + coord_flip() + labs(x = "Beer Style", y = "ABV content")
  })
  
  output$lollipop2 <- renderPlot({
    ggplot(data = style(), aes(x = Style, y = IBU)) +
  geom_point(data = style3(), aes(y = meanIBU), color = "Blue", size = 3) + 
  geom_point(color = "Red", size = 2) + 
  geom_segment((aes(x=Style, xend=Style, y=0, yend=IBU))) + coord_flip() + labs(x = "Beer Style", y = "IBU content")
  })
}
shinyApp(ui, server)
```

Tasks:

- Change the input of the x so the user can choose either IBU or ABV and they are on the same plot, with the axis label changing conditionally? Could be good to keep both or could be better to have the user choose one

- Add titles for the plots

- Add a tab where user can choose a brewery
